<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å‘˜åå°</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="admin-container">
        <header class="admin-header">
            <h1>ğŸ¯ ChatGPT Team ç®¡ç†åå°</h1>
            <button onclick="logout()" class="btn btn-secondary">é€€å‡ºç™»å½•</button>
        </header>
        
        <div class="admin-content">
            <!-- æ·»åŠ  Team -->
            <div class="card">
                <h2>â• æ·»åŠ æ–° Team</h2>
                <form id="addTeamForm">
                    <div class="form-group">
                        <label for="team_name">Team åç§°ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" id="team_name" placeholder="ç•™ç©ºåˆ™ä½¿ç”¨é‚®ç®±ä½œä¸ºåç§°">
                    </div>
                    
                    <div class="form-group">
                        <label for="session_json">Session JSON</label>
                        <textarea id="session_json" rows="8" placeholder='ç²˜è´´ä» https://chatgpt.com/api/auth/session è·å–çš„ JSON' required></textarea>
                        <small>ğŸ’¡ ä½¿ç”¨æ²¹çŒ´è„šæœ¬å¯è‡ªåŠ¨ä¸Šä¼ </small>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">åˆ›å»º Team</button>
                </form>
            </div>
            
            <!-- è‡ªåŠ¨è¸¢äººé…ç½® -->
            <div class="card">
                <h2>ğŸ¤– è‡ªåŠ¨è¸¢äººé…ç½®</h2>
                <form id="autoKickForm">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="auto_kick_enabled">
                            å¯ç”¨è‡ªåŠ¨æ£€æµ‹è¸¢äºº
                        </label>
                    </div>

                    <div class="form-group">
                        <label for="check_interval_min">æ£€æµ‹é—´éš” (ç§’)</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="number" id="check_interval_min" min="30" max="300" placeholder="æœ€å°å€¼" style="width: 100px;">
                            <span>-</span>
                            <input type="number" id="check_interval_max" min="30" max="300" placeholder="æœ€å¤§å€¼" style="width: 100px;">
                            <small>å»ºè®®: 90-120 ç§’</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="start_time">è¿è¡Œæ—¶é—´ (åŒ—äº¬æ—¶é—´)</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="time" id="start_time" style="width: 120px;">
                            <span>-</span>
                            <input type="time" id="end_time" style="width: 120px;">
                            <small>ä¾‹å¦‚: 09:00 - 22:00</small>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜é…ç½®</button>
                        <button type="button" onclick="checkNow()" class="btn btn-secondary">ğŸ” ç«‹å³æ£€æµ‹ä¸€æ¬¡</button>
                    </div>
                </form>
            </div>

            <!-- Teams åˆ—è¡¨ -->
            <div class="card">
                <h2>ğŸ“‹ Teams åˆ—è¡¨</h2>
                <button onclick="loadTeams()" class="btn btn-secondary" style="margin-bottom: 15px;">ğŸ”„ åˆ·æ–°</button>
                <div id="teamsList"></div>
            </div>

            <!-- è¸¢äººæ—¥å¿— -->
            <div class="card">
                <h2>ğŸ“œ è¸¢äººæ—¥å¿—</h2>
                <button onclick="loadKickLogs()" class="btn btn-secondary" style="margin-bottom: 15px;">ğŸ”„ åˆ·æ–°</button>
                <div id="kickLogsList"></div>
            </div>

            <!-- ä¸€é”®è·å–å¯†é’¥ -->
            <div class="card">
                <h2>ğŸ”‘ è·å–æœªä½¿ç”¨å¯†é’¥</h2>
                <div class="form-group">
                    <label for="keyCount">è¦è·å–çš„å¯†é’¥æ•°é‡</label>
                    <input type="number" id="keyCount" min="1" placeholder="è¾“å…¥æ•°é‡ï¼Œå¦‚ 10" style="width: 200px;">
                </div>
                <button onclick="getUnusedKeys()" class="btn btn-primary">ğŸ“‹ è·å–å¯†é’¥</button>
                <div id="allKeysResult" style="margin-top: 15px;"></div>
            </div>
            
            <!-- é‚€è¯·è®°å½• -->
            <div class="card">
                <h2>ğŸ“Š é‚€è¯·è®°å½•</h2>
                <button onclick="loadInvitations()" class="btn btn-secondary" style="margin-bottom: 15px;">ğŸ”„ åˆ·æ–°</button>
                <div id="invitationsList"></div>
            </div>
        </div>
    </div>

    <script>
        // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
        window.addEventListener('load', () => {
            loadTeams();
            loadInvitations();
            loadAutoKickConfig();
            loadKickLogs();
        });
        
        // æ·»åŠ  Team
        document.getElementById('addTeamForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('team_name').value.trim();
            const sessionJson = document.getElementById('session_json').value.trim();
            
            try {
                const sessionData = JSON.parse(sessionJson);
                
                const response = await fetch('/api/admin/teams', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, session_data: sessionData })
                });
                
                const data = await response.json();

                if (data.success) {
                    if (data.updated) {
                        alert('âœ… ' + data.message);
                    } else {
                        alert('âœ… Team åˆ›å»ºæˆåŠŸï¼');
                    }
                    document.getElementById('addTeamForm').reset();
                    loadTeams();
                } else {
                    alert('âŒ ' + data.error);
                }
            } catch (error) {
                alert('âŒ JSON æ ¼å¼é”™è¯¯æˆ–ç½‘ç»œé”™è¯¯');
            }
        });
        
        // åŠ è½½ Teams
        async function loadTeams() {
            try {
                const response = await fetch('/api/admin/teams');
                const data = await response.json();
                
                if (data.success) {
                    displayTeams(data.teams);
                }
            } catch (error) {
                console.error('åŠ è½½ Teams å¤±è´¥', error);
            }
        }
        
        // æ˜¾ç¤º Teams
        function displayTeams(teams) {
            const container = document.getElementById('teamsList');
            
            if (teams.length === 0) {
                container.innerHTML = '<p class="empty">æš‚æ—  Team</p>';
                return;
            }
            
            container.innerHTML = teams.map(team => `
                <div class="team-item">
                    <div class="team-header">
                        <h3>${team.name}</h3>
                        <span class="badge">${team.used_keys}/${team.total_keys} å·²ä½¿ç”¨</span>
                    </div>
                    <div class="team-info">
                        <p><strong>é‚®ç®±:</strong> ${team.email || 'N/A'}</p>
                        <p><strong>Account ID:</strong> <code>${team.account_id}</code></p>
                        <p><strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(team.created_at).toLocaleString('zh-CN')}</p>
                    </div>
                    <div class="keys-section">
                        <h4>ğŸ”‘ è®¿é—®å¯†é’¥</h4>
                        ${team.keys.map((key, idx) => `
                            <div class="key-item ${key.is_used ? 'used' : ''}">
                                <span class="key-number">#${idx + 1}</span>
                                <code class="key-code">${key.key_code}</code>
                                ${key.is_used ? 
                                    `<span class="key-status">âœ“ å·²ä½¿ç”¨ (${key.used_by_email})</span>` :
                                    `<button onclick="copyKey('${key.key_code}')" class="btn-small">å¤åˆ¶</button>
                                     <button onclick="regenerateKey(${key.id})" class="btn-small">é‡æ–°ç”Ÿæˆ</button>`
                                }
                            </div>
                        `).join('')}
                    </div>
                    <div class="team-actions">
                        <button onclick="updateToken(${team.id})" class="btn btn-secondary">æ›´æ–° Token</button>
                        <button onclick="deleteTeam(${team.id}, '${team.name}')" class="btn btn-danger">åˆ é™¤ Team</button>
                    </div>
                </div>
            `).join('');
        }
        
        // åŠ è½½é‚€è¯·è®°å½•
        async function loadInvitations() {
            try {
                const response = await fetch('/api/admin/invitations');
                const data = await response.json();
                
                if (data.success) {
                    displayInvitations(data.invitations);
                }
            } catch (error) {
                console.error('åŠ è½½é‚€è¯·è®°å½•å¤±è´¥', error);
            }
        }
        
        // æ˜¾ç¤ºé‚€è¯·è®°å½•
        function displayInvitations(invitations) {
            const container = document.getElementById('invitationsList');
            
            if (invitations.length === 0) {
                container.innerHTML = '<p class="empty">æš‚æ— é‚€è¯·è®°å½•</p>';
                return;
            }
            
            container.innerHTML = `
                <table class="invitations-table">
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>Team</th>
                            <th>é‚®ç®±</th>
                            <th>çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${invitations.map(inv => `
                            <tr>
                                <td>${new Date(inv.created_at).toLocaleString('zh-CN')}</td>
                                <td>${inv.team_name}</td>
                                <td>${inv.email}</td>
                                <td><span class="status-${inv.status}">${inv.status === 'success' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        // å¤åˆ¶å¯†é’¥
        function copyKey(key) {
            navigator.clipboard.writeText(key).then(() => {
                alert('âœ… å¯†é’¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            });
        }
        
        // é‡æ–°ç”Ÿæˆå¯†é’¥
        async function regenerateKey(keyId) {
            if (!confirm('ç¡®å®šè¦é‡æ–°ç”Ÿæˆæ­¤å¯†é’¥å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/api/admin/keys/${keyId}/regenerate`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('âœ… å¯†é’¥å·²é‡æ–°ç”Ÿæˆ');
                    loadTeams();
                } else {
                    alert('âŒ ' + data.error);
                }
            } catch (error) {
                alert('âŒ æ“ä½œå¤±è´¥');
            }
        }
        
        // æ›´æ–° Token
        async function updateToken(teamId) {
            const sessionJson = prompt('è¯·ç²˜è´´æ–°çš„ Session JSON:');
            if (!sessionJson) return;
            
            try {
                const sessionData = JSON.parse(sessionJson);
                
                const response = await fetch(`/api/admin/teams/${teamId}/token`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_data: sessionData })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('âœ… Token æ›´æ–°æˆåŠŸ');
                    loadTeams();
                } else {
                    alert('âŒ ' + data.error);
                }
            } catch (error) {
                alert('âŒ JSON æ ¼å¼é”™è¯¯');
            }
        }
        
        // åˆ é™¤ Team
        async function deleteTeam(teamId, teamName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ "${teamName}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
            
            try {
                const response = await fetch(`/api/admin/teams/${teamId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('âœ… Team å·²åˆ é™¤');
                    loadTeams();
                } else {
                    alert('âŒ ' + data.error);
                }
            } catch (error) {
                alert('âŒ åˆ é™¤å¤±è´¥');
            }
        }
        
        // è·å–æŒ‡å®šæ•°é‡çš„æœªä½¿ç”¨å¯†é’¥
        async function getUnusedKeys() {
            const count = parseInt(document.getElementById('keyCount').value);
            
            if (!count || count <= 0) {
                alert('âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/keys/all-unused', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ count })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const container = document.getElementById('allKeysResult');
                    
                    // æ¯è¡Œä¸€ä¸ªå¯†é’¥
                    const text = data.keys.join('\n');
                    
                    container.innerHTML = `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; position: relative;">
                            <div style="margin-bottom: 10px; color: #666;">
                                <strong>å·²è·å– ${data.count} ä¸ªå¯†é’¥</strong> (å‰©ä½™ ${data.total_available - data.count} ä¸ªå¯ç”¨)
                            </div>
                            <button onclick="copyAllKeys()" class="btn btn-primary" style="position: absolute; top: 10px; right: 10px; width: auto;">ğŸ“‹ å¤åˆ¶å…¨éƒ¨</button>
                            <textarea id="allKeysText" readonly style="width: 100%; min-height: 200px; font-family: 'Courier New', monospace; font-size: 13px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; margin-top: 30px;">${text}</textarea>
                        </div>
                    `;
                } else {
                    alert('âŒ ' + data.error);
                }
            } catch (error) {
                alert('âŒ ç½‘ç»œé”™è¯¯');
            }
        }
        
        // å¤åˆ¶æ‰€æœ‰å¯†é’¥
        function copyAllKeys() {
            const text = document.getElementById('allKeysText').value;
            navigator.clipboard.writeText(text).then(() => {
                alert('âœ… æ‰€æœ‰å¯†é’¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            });
        }
        
        // åŠ è½½è‡ªåŠ¨è¸¢äººé…ç½®
        async function loadAutoKickConfig() {
            try {
                const response = await fetch('/api/admin/auto-kick/config');
                const data = await response.json();

                if (data.success && data.config) {
                    const config = data.config;
                    document.getElementById('auto_kick_enabled').checked = config.enabled;
                    document.getElementById('check_interval_min').value = config.check_interval_min;
                    document.getElementById('check_interval_max').value = config.check_interval_max;
                    document.getElementById('start_time').value = config.start_time;
                    document.getElementById('end_time').value = config.end_time;
                }
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥', error);
            }
        }

        // ä¿å­˜è‡ªåŠ¨è¸¢äººé…ç½®
        document.getElementById('autoKickForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const config = {
                enabled: document.getElementById('auto_kick_enabled').checked,
                check_interval_min: parseInt(document.getElementById('check_interval_min').value),
                check_interval_max: parseInt(document.getElementById('check_interval_max').value),
                start_time: document.getElementById('start_time').value,
                end_time: document.getElementById('end_time').value
            };

            // éªŒè¯
            if (config.check_interval_min < 30 || config.check_interval_max < 30) {
                alert('âŒ æ£€æµ‹é—´éš”ä¸èƒ½å°äº 30 ç§’');
                return;
            }

            if (config.check_interval_min > config.check_interval_max) {
                alert('âŒ æœ€å°é—´éš”ä¸èƒ½å¤§äºæœ€å¤§é—´éš”');
                return;
            }

            try {
                const response = await fetch('/api/admin/auto-kick/config', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const data = await response.json();

                if (data.success) {
                    alert('âœ… é…ç½®ä¿å­˜æˆåŠŸï¼');
                    loadAutoKickConfig();
                } else {
                    alert('âŒ ' + data.error);
                }
            } catch (error) {
                alert('âŒ ä¿å­˜å¤±è´¥');
            }
        });

        // ç«‹å³æ£€æµ‹ä¸€æ¬¡
        async function checkNow() {
            if (!confirm('ç¡®å®šè¦ç«‹å³æ‰§è¡Œä¸€æ¬¡æ£€æµ‹å—ï¼Ÿ')) return;

            try {
                const response = await fetch('/api/admin/auto-kick/check-now', {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    alert('âœ… æ£€æµ‹ä»»åŠ¡å·²å¯åŠ¨ï¼Œè¯·ç¨åæŸ¥çœ‹æ—¥å¿—');
                    setTimeout(() => loadKickLogs(), 3000);
                } else {
                    alert('âŒ ' + data.error);
                }
            } catch (error) {
                alert('âŒ å¯åŠ¨å¤±è´¥');
            }
        }

        // åŠ è½½è¸¢äººæ—¥å¿—
        async function loadKickLogs() {
            try {
                const response = await fetch('/api/admin/auto-kick/logs');
                const data = await response.json();

                if (data.success) {
                    displayKickLogs(data.logs);
                }
            } catch (error) {
                console.error('åŠ è½½æ—¥å¿—å¤±è´¥', error);
            }
        }

        // æ˜¾ç¤ºè¸¢äººæ—¥å¿—
        function displayKickLogs(logs) {
            const container = document.getElementById('kickLogsList');

            if (logs.length === 0) {
                container.innerHTML = '<p class="empty">æš‚æ— è¸¢äººè®°å½•</p>';
                return;
            }

            container.innerHTML = `
                <table class="invitations-table">
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>Team</th>
                            <th>é‚®ç®±</th>
                            <th>åŸå› </th>
                            <th>çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${logs.map(log => `
                            <tr>
                                <td>${new Date(log.created_at).toLocaleString('zh-CN')}</td>
                                <td>${log.team_name}</td>
                                <td>${log.email}</td>
                                <td>${log.reason}</td>
                                <td>
                                    ${log.success ?
                                        '<span class="status-success">âœ… æˆåŠŸ</span>' :
                                        `<span class="status-failed">âŒ å¤±è´¥</span><br><small>${log.error_message || ''}</small>`
                                    }
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // é€€å‡ºç™»å½•
        async function logout() {
            try {
                await fetch('/api/admin/logout', { method: 'POST' });
                window.location.href = '/admin';
            } catch (error) {
                console.error('é€€å‡ºå¤±è´¥', error);
            }
        }
    </script>
</body>
</html>
