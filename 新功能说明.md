# 🎉 ChatGPT Team 管理系统 - 新功能说明

## 📋 更新内容

本次更新实现了以下 4 个主要功能:

### 1. 🛡️ 管理员登录 fail2ban 防护

**功能说明:**
- 防止暴力破解管理员密码
- 30 分钟内最多允许 5 次登录失败
- 超过限制后自动封禁 IP 30 分钟
- 登录失败时显示剩余尝试次数

**使用方法:**
- 无需配置,自动生效
- 登录失败时会看到提示: "密码错误,还剩 X 次尝试机会"
- 被封禁时会看到: "登录失败次数过多,请 30 分钟后再试"

**技术细节:**
- 使用 `login_attempts` 表记录所有登录尝试
- 基于 IP 地址进行限制
- 自动清理 7 天前的旧记录

---

### 2. 🔑 邀请码系统重构

**旧系统:**
- 一个 Team 只能生成固定数量的邀请码 (如 4 个)
- 每个邀请码只能使用一次
- 使用后需要重新生成

**新系统:**
- ✅ 一个 Team 可以生成**无限个**邀请码
- ✅ 每个邀请码可以**重复使用**
- ✅ Team 人数上限为 **4 人**
- ✅ 支持**永久邀请码**和**1日临时邀请码**
- ✅ 邀请码统一由管理员生成,**首次使用时自动分配至有空位的 Team**

**使用方法:**

1. **生成邀请码:**
   - 进入管理员后台并切换到「🔑 邀请码池」标签
   - 点击 "生成邀请码"
   - 可选: 指定优先分配的 Team,否则系统会在使用时自动挑选有空位的 Team
   - 选择是否为 "1日邀请码"
   - 复制邀请码分享给用户

2. **邀请码类型:**
   - **永久邀请码**: 可以一直使用,直到 Team 满员 (4人)
   - **1日邀请码**: 使用该邀请码加入的成员,24小时后如果管理员未确认,将自动踢出

3. **管理邀请码:**
   - 在邀请码池中查看所有邀请码及使用次数
   - 支持直接复制或删除不需要的邀请码
   - 每个 Team 卡片仍可查看已分配到该 Team 的邀请码列表

---

### 3. 👥 Admin 端邀请人和踢人功能

**功能说明:**
- 管理员可以直接在后台邀请成员
- 管理员可以直接在后台踢出成员
- 查看所有成员列表和详细信息

**使用方法:**

1. **查看成员:**
   - 点击 Team 卡片上的 "👥 成员管理" 按钮
   - 查看当前所有成员
   - 显示成员邮箱、角色、加入时间等信息

2. **邀请成员:**
   - 在成员管理弹窗中
   - 输入要邀请的邮箱
   - 选择是否为临时邀请 (可选)
   - 点击 "发送邀请"
   - 系统会自动发送邀请邮件

3. **踢出成员:**
   - 在成员列表中找到要踢出的成员
   - 点击 "踢出" 按钮
   - 确认后立即踢出
   - 所有操作会记录到踢人日志

**注意事项:**
- 不能踢出 Team 所有者 (account-owner)
- Team 人数上限为 4 人
- 已邀请的邮箱不能重复邀请

---

### 4. ⏰ 1日邀请码功能

**功能说明:**
- 生成有效期为 24 小时的临时邀请码
- 使用该邀请码加入的成员,24小时后自动踢出
- 管理员可以在 24 小时内确认成员,取消自动踢出

**使用场景:**
- 临时试用
- 短期合作
- 测试账号
- 限时访问

**使用方法:**

1. **生成 1日邀请码:**
   - 在邀请码管理中
   - 勾选 "1日邀请码 (24小时后自动踢出)"
   - 点击 "生成邀请码"
   - 分享给用户

2. **用户使用邀请码:**
   - 用户输入邀请码和邮箱
   - 系统会提示: "这是一个 24 小时临时邀请,到期后如果管理员未确认,将自动踢出"
   - 用户接受邀请加入 Team

3. **管理员确认成员:**
   - 进入 "📨 邀请记录" 卡片
   - 找到临时邀请的成员
   - 点击 "✅ 确认" 按钮
   - 确认后该成员将不会被自动踢出

4. **自动踢出:**
   - 自动检测服务会定期检查过期的临时邀请
   - 24小时后,如果管理员未确认,自动踢出该成员
   - 踢出操作会记录到日志

**或者直接邀请临时成员:**
- 在成员管理中点击 "邀请新成员"
- 输入邮箱
- 勾选 "临时邀请 (到期自动踢出)"
- 设置有效时长 (默认 24 小时)
- 发送邀请

---

## 🗃️ 数据库迁移

- 新增脚本 `migrate_access_keys_nullable.py`, 将 `access_keys.team_id` 修改为可为空,便于在邀请码被使用时再分配 Team
- 脚本会自动备份当前数据库为 `chatgpt_team_backup_YYYYMMDD_HHMMSS.db`
- 运行方式:
  ```bash
  python3 migrate_access_keys_nullable.py
  ```
- 迁移完成后,即可使用新的「邀请码池 + 自动分配」逻辑

---

## 🎨 界面更新

### 管理员后台

1. **Teams 列表:**
   - 网格布局,更美观
   - 显示成员数 (X/4 人)
   - 显示邀请码数量
   - 新增 "成员管理" 和 "邀请码" 按钮

2. **成员管理弹窗:**
   - 查看所有成员
   - 直接邀请新成员
   - 踢出成员
   - 显示成员详细信息

3. **邀请码池标签:**
   - 统一生成和查看所有邀请码
   - 支持复制、删除、查看使用次数
   - 可选指定优先 Team 或让系统自动分配

4. **邀请记录:**
   - 查看所有邀请记录
   - 显示邀请类型 (永久/临时)
   - 显示过期时间
   - 确认临时邀请

---

## 🔧 技术改进

### 数据库结构

1. **access_keys 表:**
   ```sql
   - is_temp: 是否为临时邀请码
   - temp_hours: 临时邀请有效时长 (小时)
   - is_cancelled: 是否已取消
   - 移除了 is_used, used_by_email, used_at (改为可重复使用)
   ```

2. **invitations 表:**
   ```sql
   - user_id: ChatGPT 用户 ID
   - is_temp: 是否为临时邀请
   - temp_expire_at: 临时邀请过期时间
   - is_confirmed: 管理员是否已确认 (取消自动踢出)
   ```

3. **login_attempts 表 (新增):**
   ```sql
   - ip_address: 登录 IP
   - username: 用户名
   - success: 是否成功
   - created_at: 登录时间
   ```

### API 更新

**新增 API:**
- `GET /api/admin/keys` - 获取邀请码池列表
- `POST /api/admin/keys` - 创建邀请码 (可选指定优先 Team)
- `DELETE /api/admin/keys/{key_id}` - 删除邀请码
- `GET /api/admin/teams/{team_id}/members` - 获取成员列表
- `DELETE /api/admin/teams/{team_id}/members/{user_id}` - 踢出成员
- `POST /api/admin/teams/{team_id}/invite` - 管理员直接邀请
- `POST /api/admin/invitations/{invitation_id}/confirm` - 确认邀请

> 兼容接口: `POST /api/admin/teams/{team_id}/keys` 仍可调用,生成的邀请码会在首次使用时自动分配 Team。

**修改的 API:**
- `POST /api/admin/login` - 添加 fail2ban 防护
- `POST /api/join` - 检查 Team 人数上限,支持临时邀请

### 自动检测服务

**新增功能:**
- 检查过期的临时邀请
- 自动踢出过期的临时成员
- 使用 invitations 表而不是 access_keys 表来判断合法成员

---

## 📊 数据迁移

**迁移脚本:** `migrate_database.py`

**迁移内容:**
1. 备份旧数据库
2. 迁移 access_keys 表结构
3. 迁移 invitations 表结构
4. 创建 login_attempts 表
5. 保留所有历史数据

**迁移说明:**
- 旧的 `is_used=1` 的密钥被标记为 `is_cancelled=1`
- 所有邀请记录已保留
- 新增了临时邀请相关字段

---

## 🚀 使用建议

### 推荐配置

1. **自动检测间隔:** 90-120 秒
2. **运行时间:** 09:00 - 22:00 (北京时间)
3. **临时邀请时长:** 24 小时

### 最佳实践

1. **永久成员:**
   - 使用永久邀请码
   - 或直接在后台邀请
   - 不需要确认操作

2. **临时成员:**
   - 使用 1日邀请码
   - 或勾选 "临时邀请"
   - 24小时内确认可转为永久成员

3. **安全建议:**
   - 定期更新 Token
   - 定期检查成员列表
   - 查看踢人日志
   - 不要分享管理员密码

---

## 🐛 故障排除

### 常见问题

1. **无法获取成员列表 (401 错误):**
   - Token 已过期
   - 解决: 更新 Team 的 Token

2. **邀请失败:**
   - Team 已满员 (4人)
   - 邮箱已被邀请
   - Token 无效

3. **自动踢人不工作:**
   - 检查自动检测是否启用
   - 检查是否在运行时间内
   - 查看服务器日志

4. **登录被封禁:**
   - 等待 30 分钟
   - 或联系管理员清理 login_attempts 表

---

## 📝 更新日志

### v2.0.0 (2025-10-31)

**新功能:**
- ✅ 管理员登录 fail2ban 防护
- ✅ 邀请码系统重构 (无限生成,可重复使用)
- ✅ Admin 端邀请人和踢人功能
- ✅ 1日邀请码功能

**改进:**
- ✅ 全新的管理员界面
- ✅ 弹窗式成员管理
- ✅ 弹窗式邀请码管理
- ✅ 更详细的邀请记录
- ✅ 更好的错误提示

**修复:**
- ✅ 数据库结构优化
- ✅ API 接口完善
- ✅ 自动检测逻辑改进

---

## 💡 下一步计划

- [ ] 批量邀请功能
- [ ] 邮件通知功能
- [ ] 成员权限管理
- [ ] 统计报表功能
- [ ] API 文档

---

## 📞 支持

如有问题,请查看:
1. 服务器控制台日志
2. 踢人日志记录
3. 浏览器控制台 (F12)
4. 数据库备份文件

---

**祝使用愉快! 🎉**
